<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demo of Html Diff</title>
    <style>
        ins {
            color: green;
        }

        del {
            color: red;
        }
        .batch-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .file-input {
            margin: 10px 0;
        }
        #batchResult {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .result-item {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        #processingStatus {
            margin: 10px 0;
            padding: 10px;
            background-color: #e8f4f8;
            border-radius: 5px;
        }
        .summary {
            margin: 15px 0;
            padding: 15px;
            background-color: #f0f7fb;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .summary h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .error-item {
            margin-left: 20px;
            font-size: 0.9em;
        }
        .zip-download-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f8f5;
            border-radius: 5px;
            text-align: center;
        }
        .zip-download {
            display: inline-block;
            padding: 10px 20px;
            background-color: #27ae60;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .zip-download:hover {
            background-color: #229954;
        }
    </style>
    <style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <!-- 添加JSZip库用于创建压缩文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<body>
<h1>Html Diff</h1>
<form action="#" onsubmit="return false">
    <table width="100%">
        <tr>
            <td width="50%">
              <textarea style="width:100%;height: 200px;border: #60bd90 1px solid" id="oldHtml">
                <div>Hamlet: Do you see yonder cloud that's almost in shape of a camel?
                <p>Polonius: By the mass, and 'tis like a camel, indeed.</p>
                Hamlet: Methinks it is like a weasel.
                Polonius: It is backed like a weasel.
                Hamlet: Or like a whale?
                Polonius: Very like a whale.
                -- Shakespeare</div>
              </textarea>
            </td>
            <td width="50%">
              <textarea style="width:100%;height: 200px;border: #60bd90 1px solid" id="newHtml">
                <div>Hamlet: Do you see the cloud over there that's almost the shape of a camel?
                  <div>Polonius: By golly, it is like a camel, indeed.</div>
                  Hamlet: I think it looks like a weasel.
                  <p>Polonius: It is shaped like a weasel.</p>          Hamlet: Or like a whale?
                  Polonius: It's totally like a whale.
                  -- Shakespeare
                </div>
              </textarea>
            </td>
        </tr>
    </table>
    <div id="tmp"></div>
    <p>
        <input type="button" onclick="diff1()" value="Compute Diff And Recover TWO Document"/>
        <input type="button" onclick="diff2()" value="Compute Diff And Generate ONE Document"/>
    </p>

    <!-- 批量处理部分 -->
    <div class="batch-section">
        <h2>批量处理文件夹</h2>
        <p>选择两个包含txt文件的文件夹，系统会自动比较文件名相同的文件：</p>
        <div class="file-input">
            <label for="folder1">旧版本文件夹：</label>
            <input type="file" id="folder1" webkitdirectory directory multiple accept=".txt"/>
        </div>
        <div class="file-input">
            <label for="folder2">新版本文件夹：</label>
            <input type="file" id="folder2" webkitdirectory directory multiple accept=".txt"/>
        </div>
        <p>
            <input type="button" onclick="batchProcess()" value="开始批量处理"/>
        </p>
        <div id="batchResult"></div>
    </div>
</form>

<div id="diffdatediv"></div>

<table width="100%">
    <tr id="diffHtml1">
        <td width="50%" valign="top" id="oldDiffHtml"></td>
        <td width="50%" valign="top" id="newDiffHtml"></td>
    </tr>
    <tr id="diffHtml2">
        <td width="100%" valign="top" id="oneDiffHtml"></td>
    </tr>
</table>

<a href="https://github.com/NPCDW/HtmlDiff" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
</body>

<script src="lib/diff_match_patch.js"></script>
<script src="js/htmldiff.js"></script>
<script src="js/htmldiff2.js"></script>
<script>
    function diff1() {
        document.getElementById("diffHtml1").style.display="none";
        document.getElementById("diffHtml2").style.display="none";

        var html1 = document.getElementById('oldHtml').value;
        var html2 = document.getElementById('newHtml').value;

        let diffHtml = new HtmlDiff();
        let {time, oldDiffHtml, newDiffHtml} = diffHtml.diff_launch(html1, html2)

        document.getElementById('oldDiffHtml').innerHTML = oldDiffHtml
        document.getElementById('newDiffHtml').innerHTML = newDiffHtml

        document.getElementById("diffHtml1").style.display="block";
    }

    function diff2() {
        document.getElementById("diffHtml1").style.display="none";
        document.getElementById("diffHtml2").style.display="none";

        var html1 = document.getElementById('oldHtml').value;
        var html2 = document.getElementById('newHtml').value;

        let diffHtml2 = new HtmlDiff2();
        let {time, diffHtml} = diffHtml2.diff_launch(html1, html2)

        document.getElementById('oneDiffHtml').innerHTML = diffHtml

        document.getElementById("diffHtml2").style.display="block";
    }

    // 批量处理函数
    function batchProcess() {
        const folder1 = document.getElementById('folder1').files;
        const folder2 = document.getElementById('folder2').files;
        const resultDiv = document.getElementById('batchResult');
        
        // 清空结果区域
        resultDiv.innerHTML = '';
        
        if (folder1.length === 0 || folder2.length === 0) {
            resultDiv.innerHTML = '<div class="error">请选择两个文件夹</div>';
            return;
        }
        
        // 创建文件名到文件对象的映射
        const fileMap1 = {};
        for (let i = 0; i < folder1.length; i++) {
            const file = folder1[i];
            const fileName = file.name;
            if (fileName.endsWith('.txt')) {
                fileMap1[fileName] = file;
            }
        }
        
        const fileMap2 = {};
        for (let i = 0; i < folder2.length; i++) {
            const file = folder2[i];
            const fileName = file.name;
            if (fileName.endsWith('.txt')) {
                fileMap2[fileName] = file;
            }
        }
        
        // 找出共同的文件名
        const commonFiles = Object.keys(fileMap1).filter(fileName => fileMap2.hasOwnProperty(fileName));
        
        if (commonFiles.length === 0) {
            resultDiv.innerHTML = '<div class="error">没有找到文件名相同的txt文件</div>';
            return;
        }
        
        resultDiv.innerHTML += `<div>找到 ${commonFiles.length} 个共同的txt文件需要处理</div>`;
        
        // 实例化HtmlDiff2
        const htmlDiff2 = new HtmlDiff2();
        
        // 创建JSZip实例用于打包所有结果文件
        const zip = new JSZip();
        
        // 创建处理状态显示
        const statusDiv = document.createElement('div');
        statusDiv.id = 'processingStatus';
        statusDiv.innerHTML = '<p>正在处理文件，请稍候...</p>';
        resultDiv.appendChild(statusDiv);
        
        // 跟踪已处理的文件数量
        let processedCount = 0;
        let successCount = 0;
        let errorCount = 0;
        const errorMessages = [];
        
        // 处理每个共同文件
        commonFiles.forEach(fileName => {
            const file1 = fileMap1[fileName];
            const file2 = fileMap2[fileName];
            
            const reader1 = new FileReader();
            reader1.onload = function(e1) {
                const content1 = e1.target.result;
                
                const reader2 = new FileReader();
                reader2.onload = function(e2) {
                    const content2 = e2.target.result;
                    
                    try {
                        // 执行差异比较
                        const { time, diffHtml } = htmlDiff2.diff_launch(content1, content2);
                        
                        // 移除HTML标签，只保留纯文本
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = diffHtml;
                        const plainText = tempDiv.textContent || tempDiv.innerText || '';
                        
                        // 将纯文本添加到ZIP文件中
                        zip.file(fileName, plainText);
                        
                        successCount++;
                    } catch (error) {
                        errorCount++;
                        errorMessages.push(`${fileName} - 处理出错: ${error.message}`);
                    } finally {
                        processedCount++;
                        statusDiv.innerHTML = `<p>已处理 ${processedCount}/${commonFiles.length} 个文件</p>`;
                        
                        // 检查是否所有文件都已处理完成
                        if (processedCount === commonFiles.length) {
                            // 显示处理摘要
                            let summaryHtml = `<div class="summary">
                                <h3>处理摘要：</h3>
                                <p>总文件数：${commonFiles.length}</p>
                                <p class="success">成功处理：${successCount}</p>`;
                            
                            if (errorCount > 0) {
                                summaryHtml += `<p class="error">处理失败：${errorCount}</p>`;
                                errorMessages.forEach(msg => {
                                    summaryHtml += `<div class="error-item">${msg}</div>`;
                                });
                            }
                            
                            summaryHtml += '</div>';
                            
                            // 添加到结果区域
                            const summaryDiv = document.createElement('div');
                            summaryDiv.innerHTML = summaryHtml;
                            resultDiv.appendChild(summaryDiv);
                            
                            // 如果有成功处理的文件，生成ZIP下载链接
                            if (successCount > 0) {
                                zip.generateAsync({type: 'blob'}).then(function(content) {
                                    const a = document.createElement('a');
                                    a.href = URL.createObjectURL(content);
                                    a.download = 'diff_results_' + new Date().getTime() + '.zip';
                                    a.textContent = '下载所有结果文件（ZIP格式）';
                                    a.className = 'zip-download';
                                    
                                    const downloadDiv = document.createElement('div');
                                    downloadDiv.className = 'zip-download-container';
                                    downloadDiv.innerHTML = '<h3>批量下载：</h3>';
                                    downloadDiv.appendChild(a);
                                    resultDiv.appendChild(downloadDiv);
                                });
                            }
                        }
                    }
                };
                
                reader2.readAsText(file2);
            };
            
            reader1.readAsText(file1);
        });
    }

</script>
</html>